<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dimensionality reduction and batch effect removal using NewWave • NewWave</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Dimensionality reduction and batch effect removal using NewWave">
<meta property="og:description" content="NewWave">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">NewWave</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vignette.html">Dimensionality reduction and batch effect removal using NewWave</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/fedeago/NewWave/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="vignette_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Dimensionality reduction and batch effect removal using NewWave</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/fedeago/NewWave/blob/master/vignettes/vignette.Rmd"><code>vignettes/vignette.Rmd</code></a></small>
      <div class="hidden name"><code>vignette.Rmd</code></div>

    </div>

    
    
<div id="installation" class="section level1">
<h1 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h1>
<p>First of all we need to install NewWave:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span>
<span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html">install</a></span><span class="op">(</span><span class="st">"NewWave"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span>
  <span class="op">{</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Oshlack/splatter">splatter</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">irlba</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jkrijthe/Rtsne">Rtsne</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mclust-org.github.io/mclust/">mclust</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">NewWave</span><span class="op">)</span><span class="op">}</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>NewWave is a new package that assumes a Negative Binomial distributions for dimensionality reduction and batch effect removal. In order to reduce the memory consumption it uses a PSOCK cluster combined with the R package SharedObject that allow to share a matrix between different cores without memory duplication. Thanks to that we can massively parallelize the estimation process with huge benefit in terms of time consumption. We can reduce even more the time consumption using some minibatch approaches on the different steps of the optimization.</p>
<p>I am going to show how to use NewWave with example data generated with Splatter.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/splatter/man/newParams.html">newSplatParams</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">N</span><span class="op">=</span><span class="fl">500</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/splatter/man/splatSimulate.html">splatSimulateGroups</a></span><span class="op">(</span><span class="va">params</span>,batchCells<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">N</span><span class="op">/</span><span class="fl">2</span>,<span class="va">N</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,
                           group.prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">10</span><span class="op">)</span>,
                           de.prob <span class="op">=</span> <span class="fl">0.2</span>,
                           verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </code></pre></div>
<p>Now we have a dataset with 500 cells and 10000 genes, I will use only the 500 most variable genes. NewWave takes as input raw data, not normalized.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12359</span><span class="op">)</span>
<span class="va">hvg</span> <span class="op">&lt;-</span> <span class="fu">rowVars</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">hvg</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">hvg</span>,decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">]</span>,<span class="op">]</span></code></pre></div>
<p>As you can see there is a variable called batch in the colData section.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">colData</span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="co">#&gt; DataFrame with 500 rows and 4 columns</span>
<span class="co">#&gt;                Cell       Batch    Group ExpLibSize</span>
<span class="co">#&gt;         &lt;character&gt; &lt;character&gt; &lt;factor&gt;  &lt;numeric&gt;</span>
<span class="co">#&gt; Cell1         Cell1      Batch1  Group6     54405.5</span>
<span class="co">#&gt; Cell2         Cell2      Batch1  Group10    65015.6</span>
<span class="co">#&gt; Cell3         Cell3      Batch1  Group7     46966.5</span>
<span class="co">#&gt; Cell4         Cell4      Batch1  Group8     62861.7</span>
<span class="co">#&gt; Cell5         Cell5      Batch1  Group3     62433.4</span>
<span class="co">#&gt; ...             ...         ...      ...        ...</span>
<span class="co">#&gt; Cell496     Cell496      Batch2  Group10    83716.0</span>
<span class="co">#&gt; Cell497     Cell497      Batch2  Group10    64639.5</span>
<span class="co">#&gt; Cell498     Cell498      Batch2  Group2     47283.1</span>
<span class="co">#&gt; Cell499     Cell499      Batch2  Group7     51248.2</span>
<span class="co">#&gt; Cell500     Cell500      Batch2  Group3     54452.3</span></code></pre></div>
<p><strong>IMPORTANT:</strong> For batch effecr removal the batch variable must be a factor</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span><span class="op">$</span><span class="va">Batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Batch</span><span class="op">)</span></code></pre></div>
<p>We also have a variable called Group that represent the cell type labels.</p>
<p>We can see the how the cells are distributed between group and batch</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/irlba/man/prcomp_irlba.html">prcomp_irlba</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>,n<span class="op">=</span><span class="fl">10</span><span class="op">)</span>
<span class="va">plot_data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Rtsne/man/Rtsne.html">Rtsne</a></span><span class="op">(</span><span class="va">pca</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot_data</span><span class="op">$</span><span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Batch</span>
<span class="va">plot_data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Group</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X1</span>,y<span class="op">=</span><span class="va">X2</span>,col<span class="op">=</span><span class="va">group</span>, shape<span class="op">=</span><span class="va">batch</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>There is a clear batch effect between the cells.</p>
<p>Let’s try to correct it.</p>
</div>
<div id="newwave" class="section level1">
<h1 class="hasAnchor">
<a href="#newwave" class="anchor"></a>NewWave</h1>
<p>I am going to show different implementation and the suggested way to use them with the given hardware.</p>
<p>Some advise:</p>
<ul>
<li>Verbose option has default FALSE, in this vignette I will change it for explanatory intentions, don’t do it with big dataset because it can sensibly slower the computation</li>
<li>There are no concern about the dimension of mini-batches, I always used the 10% of the observations</li>
</ul>
<div id="standard-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#standard-usage" class="anchor"></a>Standard usage</h2>
<p>This is the way to insert the batch variable, in the same manner can be inserted other cell-related variable and if you need some gene related variable those can be inserted in V.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/newWave.html">newWave</a></span><span class="op">(</span><span class="va">data</span>,X <span class="op">=</span> <span class="st">"~Batch"</span>, K<span class="op">=</span><span class="fl">10</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Time of setup</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.011   0.000   0.257 </span>
<span class="co">#&gt; Time of initialization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.030   0.004   0.490</span>
<span class="co">#&gt; Iteration 1</span>
<span class="co">#&gt; penalized log-likelihood = -1296831.91621212</span>
<span class="co">#&gt; Time of dispersion optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.679   0.052   0.647</span>
<span class="co">#&gt; after optimize dispersion = -1057745.67672738</span>
<span class="co">#&gt; Time of right optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.000   0.000   6.191</span>
<span class="co">#&gt; after right optimization= -1057024.07833179</span>
<span class="co">#&gt; after orthogonalization = -1057024.05501048</span>
<span class="co">#&gt; Time of left optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.031   0.045   6.075</span>
<span class="co">#&gt; after left optimization= -1056755.51081916</span>
<span class="co">#&gt; after orthogonalization = -1056755.50871805</span>
<span class="co">#&gt; Iteration 2</span>
<span class="co">#&gt; penalized log-likelihood = -1056755.50871805</span>
<span class="co">#&gt; Time of dispersion optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.763   0.067   0.701</span>
<span class="co">#&gt; after optimize dispersion = -1056749.891008</span>
<span class="co">#&gt; Time of right optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.001   0.000   5.314</span>
<span class="co">#&gt; after right optimization= -1056722.11257822</span>
<span class="co">#&gt; after orthogonalization = -1056722.11124581</span>
<span class="co">#&gt; Time of left optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.040   0.045   4.569</span>
<span class="co">#&gt; after left optimization= -1056712.02255836</span>
<span class="co">#&gt; after orthogonalization = -1056712.02250333</span></code></pre></div>
<p>In order to make it faster you can increase the number of cores using “children” parameter:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/newWave.html">newWave</a></span><span class="op">(</span><span class="va">data</span>,X <span class="op">=</span> <span class="st">"~Batch"</span>, K<span class="op">=</span><span class="fl">10</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>, children<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; Time of setup</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.010   0.000   3.273 </span>
<span class="co">#&gt; Time of initialization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.031   0.004   0.413</span>
<span class="co">#&gt; Iteration 1</span>
<span class="co">#&gt; penalized log-likelihood = -1296831.91621601</span>
<span class="co">#&gt; Time of dispersion optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.690   0.028   0.636</span>
<span class="co">#&gt; after optimize dispersion = -1057745.67587822</span>
<span class="co">#&gt; Time of right optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.001   0.000   3.164</span>
<span class="co">#&gt; after right optimization= -1057024.06868609</span>
<span class="co">#&gt; after orthogonalization = -1057024.04535576</span>
<span class="co">#&gt; Time of left optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.030   0.013   2.907</span>
<span class="co">#&gt; after left optimization= -1056755.50575859</span>
<span class="co">#&gt; after orthogonalization = -1056755.50366</span>
<span class="co">#&gt; Iteration 2</span>
<span class="co">#&gt; penalized log-likelihood = -1056755.50366</span>
<span class="co">#&gt; Time of dispersion optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.721   0.080   0.672</span>
<span class="co">#&gt; after optimize dispersion = -1056749.88553503</span>
<span class="co">#&gt; Time of right optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.002   0.000   2.723</span>
<span class="co">#&gt; after right optimization= -1056722.13659856</span>
<span class="co">#&gt; after orthogonalization = -1056722.13525283</span>
<span class="co">#&gt; Time of left optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.020   0.025   2.261</span>
<span class="co">#&gt; after left optimization= -1056712.04955364</span>
<span class="co">#&gt; after orthogonalization = -1056712.04948209</span></code></pre></div>
</div>
<div id="commonwise-dispersion-and-minibatch-approaches" class="section level2">
<h2 class="hasAnchor">
<a href="#commonwise-dispersion-and-minibatch-approaches" class="anchor"></a>Commonwise dispersion and minibatch approaches</h2>
<p>If you do not have an high number of cores to run newWave this is the fastest way to run. The optimization process is done by three process itereated until convercence.</p>
<ul>
<li>Optimization of the dispersion parameters</li>
<li>Optimization of the gene related parameters</li>
<li>Optimization of the cell related parameters</li>
</ul>
<p>Each of these three steps can be accelerated using mini batch, the number of observation is settled with these parameters:</p>
<ul>
<li>n_gene_disp : Number of genes to use in the dispersion optimization</li>
<li>n_cell_par : Number of cells to use in the cells related parameters optimization</li>
<li>n_gene_par : Number of genes to use in the genes related parameters optimization</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/newWave.html">newWave</a></span><span class="op">(</span><span class="va">data</span>,X <span class="op">=</span> <span class="st">"~Batch"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>,K<span class="op">=</span><span class="fl">10</span>, children<span class="op">=</span><span class="fl">2</span>,
                n_gene_disp <span class="op">=</span> <span class="fl">100</span>, n_gene_par <span class="op">=</span> <span class="fl">100</span>, n_cell_par <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="co">#&gt; Time of setup</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.009   0.000   0.260 </span>
<span class="co">#&gt; Time of initialization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.034   0.000   0.345</span>
<span class="co">#&gt; Iteration 1</span>
<span class="co">#&gt; penalized log-likelihood = -1296831.9162208</span>
<span class="co">#&gt; Time of dispersion optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.660   0.036   0.612</span>
<span class="co">#&gt; after optimize dispersion = -1057745.67829633</span>
<span class="co">#&gt; Time of right optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.001   0.001   3.063</span>
<span class="co">#&gt; after right optimization= -1057024.12474379</span>
<span class="co">#&gt; after orthogonalization = -1057024.10142245</span>
<span class="co">#&gt; Time of left optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.028   0.018   2.933</span>
<span class="co">#&gt; after left optimization= -1056755.49557259</span>
<span class="co">#&gt; after orthogonalization = -1056755.49345736</span>
<span class="co">#&gt; Iteration 2</span>
<span class="co">#&gt; penalized log-likelihood = -1056755.49345736</span>
<span class="co">#&gt; Time of dispersion optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.280   0.060   0.211</span>
<span class="co">#&gt; after optimize dispersion = -1056750.40884817</span>
<span class="co">#&gt; Time of right optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.001   0.000   0.575</span>
<span class="co">#&gt; after right optimization= -1056745.94533161</span>
<span class="co">#&gt; after orthogonalization = -1056745.94506275</span>
<span class="co">#&gt; Time of left optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.020   0.036   0.331</span>
<span class="co">#&gt; after left optimization= -1056745.74959485</span>
<span class="co">#&gt; after orthogonalization = -1056745.74956973</span></code></pre></div>
</div>
<div id="genewise-dispersion-mini-batch" class="section level2">
<h2 class="hasAnchor">
<a href="#genewise-dispersion-mini-batch" class="anchor"></a>Genewise dispersion mini-batch</h2>
<p>If you have a lot of core disposable or you want to estimate a genewise dispersion parameter this is the fastes configuration:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/newWave.html">newWave</a></span><span class="op">(</span><span class="va">data</span>,X <span class="op">=</span> <span class="st">"~Batch"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>,K<span class="op">=</span><span class="fl">10</span>, children<span class="op">=</span><span class="fl">2</span>,
                n_gene_par <span class="op">=</span> <span class="fl">100</span>, n_cell_par <span class="op">=</span> <span class="fl">100</span>, commondispersion <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; Time of setup</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.006   0.004   0.261 </span>
<span class="co">#&gt; Time of initialization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.040   0.000   0.409</span>
<span class="co">#&gt; Iteration 1</span>
<span class="co">#&gt; penalized log-likelihood = -1296831.9161048</span>
<span class="co">#&gt; Time of dispersion optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.622   0.056   0.593</span>
<span class="co">#&gt; after optimize dispersion = -1057745.67570347</span>
<span class="co">#&gt; Time of right optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.002   0.000   2.986</span>
<span class="co">#&gt; after right optimization= -1057024.07648382</span>
<span class="co">#&gt; after orthogonalization = -1057024.05316422</span>
<span class="co">#&gt; Time of left optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.018   0.024   2.924</span>
<span class="co">#&gt; after left optimization= -1056755.4930995</span>
<span class="co">#&gt; after orthogonalization = -1056755.49099402</span>
<span class="co">#&gt; Iteration 2</span>
<span class="co">#&gt; penalized log-likelihood = -1056755.49099402</span>
<span class="co">#&gt; Time of dispersion optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.088   0.049   0.545</span>
<span class="co">#&gt; after optimize dispersion = -1052862.00530605</span>
<span class="co">#&gt; Time of right optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.000   0.001   0.550</span>
<span class="co">#&gt; after right optimization= -1052857.60430509</span>
<span class="co">#&gt; after orthogonalization = -1052857.60377622</span>
<span class="co">#&gt; Time of left optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.028   0.018   0.610</span>
<span class="co">#&gt; after left optimization= -1052826.24612377</span>
<span class="co">#&gt; after orthogonalization = -1052826.24525463</span>
<span class="co">#&gt; Iteration 3</span>
<span class="co">#&gt; penalized log-likelihood = -1052826.24525463</span>
<span class="co">#&gt; Time of dispersion optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.092   0.046   0.264</span>
<span class="co">#&gt; after optimize dispersion = -1052826.26214855</span>
<span class="co">#&gt; Time of right optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.002   0.000   0.539</span>
<span class="co">#&gt; after right optimization= -1052821.76592427</span>
<span class="co">#&gt; after orthogonalization = -1052821.76498151</span>
<span class="co">#&gt; Time of left optimization</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.029   0.014   0.589</span>
<span class="co">#&gt; after left optimization= -1052793.47966384</span>
<span class="co">#&gt; after orthogonalization = -1052793.47904362</span></code></pre></div>
<p>NB: do not use n_gene_disp in this case, it will slower the computation.</p>
<p>Now I can use the latent dimension rapresentation for visualization purpose:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">latent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html">reducedDim</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>

<span class="va">tsne_latent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Rtsne/man/Rtsne.html">Rtsne</a></span><span class="op">(</span><span class="va">latent</span><span class="op">)</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span>
<span class="va">tsne_latent</span><span class="op">$</span><span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Batch</span>
<span class="va">tsne_latent</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Group</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">tsne_latent</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X1</span>,y<span class="op">=</span><span class="va">X2</span>,col<span class="op">=</span><span class="va">group</span>, shape<span class="op">=</span><span class="va">batch</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>or for clustering:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op">(</span><span class="va">latent</span>, <span class="fl">10</span><span class="op">)</span>

<span class="fu"><a href="https://mclust-org.github.io/mclust/reference/adjustedRandIndex.html">adjustedRandIndex</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">$</span><span class="va">cluster</span>, <span class="va">data</span><span class="op">$</span><span class="va">Group</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.7012788</span></code></pre></div>
</div>
</div>
<div id="session-information" class="section level1">
<h1 class="hasAnchor">
<a href="#session-information" class="anchor"></a>Session Information</h1>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; R Under development (unstable) (2021-02-05 r79941)</span>
<span class="co">#&gt; Platform: x86_64-pc-linux-gnu (64-bit)</span>
<span class="co">#&gt; Running under: Ubuntu 20.04.2 LTS</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Matrix products: default</span>
<span class="co">#&gt; BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; locale:</span>
<span class="co">#&gt;  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span>
<span class="co">#&gt;  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span>
<span class="co">#&gt;  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             </span>
<span class="co">#&gt;  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span>
<span class="co">#&gt;  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span>
<span class="co">#&gt; [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attached base packages:</span>
<span class="co">#&gt; [1] parallel  stats4    stats     graphics  grDevices utils     datasets </span>
<span class="co">#&gt; [8] methods   base     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; other attached packages:</span>
<span class="co">#&gt;  [1] NewWave_1.1.1                mclust_5.4.7                </span>
<span class="co">#&gt;  [3] ggplot2_3.3.3                Rtsne_0.15                  </span>
<span class="co">#&gt;  [5] irlba_2.3.3                  Matrix_1.3-2                </span>
<span class="co">#&gt;  [7] splatter_1.15.1              SingleCellExperiment_1.13.10</span>
<span class="co">#&gt;  [9] SummarizedExperiment_1.21.1  Biobase_2.51.0              </span>
<span class="co">#&gt; [11] GenomicRanges_1.43.3         GenomeInfoDb_1.27.6         </span>
<span class="co">#&gt; [13] IRanges_2.25.6               S4Vectors_0.29.7            </span>
<span class="co">#&gt; [15] BiocGenerics_0.37.1          MatrixGenerics_1.3.1        </span>
<span class="co">#&gt; [17] matrixStats_0.58.0          </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; loaded via a namespace (and not attached):</span>
<span class="co">#&gt;  [1] rsvd_1.0.3             Rcpp_1.0.6             locfit_1.5-9.4        </span>
<span class="co">#&gt;  [4] lattice_0.20-41        assertthat_0.2.1       rprojroot_2.0.2       </span>
<span class="co">#&gt;  [7] digest_0.6.27          R6_2.5.0               backports_1.2.1       </span>
<span class="co">#&gt; [10] evaluate_0.14          highr_0.8              pillar_1.4.7          </span>
<span class="co">#&gt; [13] zlibbioc_1.37.0        rlang_0.4.10           checkmate_2.0.0       </span>
<span class="co">#&gt; [16] rmarkdown_2.6          pkgdown_1.6.1.9000     labeling_0.4.2        </span>
<span class="co">#&gt; [19] textshaping_0.3.0      desc_1.2.0             BiocParallel_1.25.4   </span>
<span class="co">#&gt; [22] stringr_1.4.0          SharedObject_1.5.5     beachmat_2.7.6        </span>
<span class="co">#&gt; [25] RCurl_1.98-1.2         munsell_0.5.0          DelayedArray_0.17.7   </span>
<span class="co">#&gt; [28] BiocSingular_1.7.2     compiler_4.1.0         xfun_0.21             </span>
<span class="co">#&gt; [31] pkgconfig_2.0.3        systemfonts_1.0.1      htmltools_0.5.1.1     </span>
<span class="co">#&gt; [34] tibble_3.0.6           GenomeInfoDbData_1.2.4 crayon_1.4.1          </span>
<span class="co">#&gt; [37] withr_2.4.1            bitops_1.0-6           grid_4.1.0            </span>
<span class="co">#&gt; [40] gtable_0.3.0           lifecycle_0.2.0        magrittr_2.0.1        </span>
<span class="co">#&gt; [43] scales_1.1.1           ScaledMatrix_0.99.2    stringi_1.5.3         </span>
<span class="co">#&gt; [46] cachem_1.0.3           farver_2.0.3           XVector_0.31.1        </span>
<span class="co">#&gt; [49] fs_1.5.0               ellipsis_0.3.1         ragg_0.4.1            </span>
<span class="co">#&gt; [52] vctrs_0.3.6            tools_4.1.0            glue_1.4.2            </span>
<span class="co">#&gt; [55] fastmap_1.1.0          yaml_2.2.1             colorspace_2.0-0      </span>
<span class="co">#&gt; [58] memoise_2.0.0          knitr_1.31</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Federico Agostinis, Chiara Romualdi, Gabriele Sales, Davide Risso.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
